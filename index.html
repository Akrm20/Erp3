<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ุงูุฃุตูุงู - ูุงููุฑุง ูุจุทุงูุฉ ุงูุตูู IndexedDB</title>
    <!-- ุชุถููู Tailwind CSS (ูุน ุชุฌุงูู ุฑุณุงูุฉ ุงูุชุญุฐูุฑุ ูุฃูู ููุงุฎุชุจุงุฑ) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ุชุฎุตูุต ุงูุฃููุงุท ูุชุดูู ุงูููู ุงูุฃุณุงุณู ูุงูุฎุท -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#10B981', // ููู ุฃุฎุถุฑ ุฃุณุงุณู
                        'secondary-gray': '#F9FAFB',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ุฃููุงุท ุซุงุจุชุฉ ูุฃููููุฉ ุงูุตูุฑุฉ ุงููุตุบุฑุฉ */
        .product-image-icon {
            width: 48px; /* ุญุฌู ุงูุฃููููุฉ */
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #E5E7EB;
        }
        /* ุฅุฎูุงุก ูุคูุช ูุนูุตุฑ ุงูููุฏูู ุนูุฏ ุนุฏู ุงูุงุณุชุฎุฏุงู */
        #cameraStream:not([srcObject]) {
            display: none;
        }
        /* ููุนูุงุตุฑ ุงูุชู ูููู ุฃู ุชุธูุฑ ุนูููุง ุฑุณุงุฆู ุงูุฎุทุฃ */
        .error-message {
            color: #EF4444; 
            font-size: 0.8rem;
            margin-top: 4px;
        }
        /* ููุท ููุฑุณุงุฆู ูุงูุชุญููู */
        .loading-overlay {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 0.75rem;
        }
        /* ุฅุฎูุงุก ูุคุดุฑ ุงูููู ูุฌุนู ุงูุฒุฑ ุงูุนููู ูู ุงููุชุญูู */
        #imageFileInput {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans antialiased min-h-screen">

    <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 mt-6 relative">
        <!-- ุทุจูุฉ ุงูุชุญููู ุนูุฏ ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="text-center text-primary-blue">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary-blue mx-auto mb-3"></div>
                <p class="font-semibold">ุฌุงุฑู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ...</p>
            </div>
        </div>

        <!-- ุฑุณุงูุฉ ุงููุธุงู ุงููุคูุชุฉ (Success/Error) -->
        <div id="systemMessage" class="hidden p-3 mb-4 rounded-lg text-center font-semibold transition-all duration-300 transform">
            <!-- ุณูุชู ุชุนุจุฆุฉ ูุญุชูู ุงูุฑุณุงูุฉ ููุง -->
        </div>

        <h1 class="text-3xl font-extrabold text-primary-blue mb-8 border-b-4 border-primary-blue/30 pb-3 text-center">
            ุฅุฏุงุฑุฉ ุงูุฃุตูุงู: IndexedDB ูุงููุงููุฑุง
        </h1>

        <!-- ูุณู ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ (ูุน ุงููุงููุฑุง) -->
        <div class="mb-10 border-2 border-primary-blue/30 p-6 rounded-lg bg-secondary-gray shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-5">ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- ุนููุฏ ุจูุงูุงุช ุงูุตูู -->
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label for="productCode" class="block text-sm font-medium text-gray-700">ููุฏ ุงูุตูู</label>
                        <input type="text" id="productCode" placeholder="ูุซุงู: A-458" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2.5 bg-white">
                        <small class="text-gray-500">ุณูุชู ุชูููุฏ ููุฏ ุชููุงุฆู ุฅุฐุง ุชูุฑู ูุงุฑุบุงู.</small>
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">ุงุณู ุงูุตูู</label>
                        <input type="text" id="productName" placeholder="ูุซุงู: ุฌูุงุฒ ุญุงุณูุจ ูุญููู" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2.5 bg-white">
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">ุณุนุฑ ุงูุจูุน (ุฑูุงู)</label>
                        <input type="number" id="productPrice" placeholder="0.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue border p-2.5 bg-white" min="0">
                    </div>
                    <button onclick="addProduct()" class="w-full mt-4 py-3 px-6 rounded-lg shadow-md text-base font-medium text-white bg-primary-blue hover:bg-primary-blue/90 transition duration-150">
                        ุญูุธ ุงูุตูู
                    </button>
                </div>

                <!-- ุนููุฏ ุงููุงููุฑุง ูุงูุชูุงุท ุงูุตูุฑุฉ -->
                <div class="md:col-span-2 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">ุงูุตูุฑุฉ ุงููุตุบุฑุฉ ููุตูู</h3>
                    
                    <div id="cameraArea" class="space-y-3">
                        <!-- ุนุฑุถ ุงููุงููุฑุง -->
                        <div class="relative w-full overflow-hidden rounded-lg shadow-inner border border-gray-300">
                            <video id="cameraStream" autoplay class="w-full h-auto rounded-lg max-h-[300px] bg-gray-900"></video>
                            <canvas id="photoCanvas" class="hidden"></canvas>
                            <div id="capturePlaceholder" class="w-full h-[300px] flex items-center justify-center text-gray-400 border-dashed border-2 rounded-lg bg-gray-50">
                                <span id="cameraMessage">ุงุถุบุท "ุชุดุบูู ุงููุงููุฑุง" ููุจุฏุก.</span>
                            </div>
                        </div>

                        <!-- ุฃุฒุฑุงุฑ ุงูุชุญูู ุจุงููุงููุฑุง -->
                        <div class="flex flex-col md:flex-row gap-2">
                            <button id="startButton" onclick="startCamera()" class="flex-1 py-2 rounded-lg text-white bg-indigo-500 hover:bg-indigo-600 transition">
                                ุชุดุบูู ุงููุงููุฑุง
                            </button>
                            <button id="captureButton" onclick="capturePhoto()" class="flex-1 py-2 rounded-lg text-white bg-red-500 hover:bg-red-600 transition" disabled>
                                ุงูุชูุงุท ุตูุฑุฉ
                            </button>
                        </div>
                        
                        <!-- ุฒุฑ ุงุฎุชูุงุฑ ุงูุตูุฑุฉ ูู ุงูุฌูุงุฒ -->
                        <div class="relative w-full">
                            <!-- ุญูู ุงูุฅุฏุฎุงู ูู ุงูุนูุตุฑ ุงูุฐู ูููุฑ ุนููู ุงููุณุชุฎุฏูุ ููู ุงูุฒุฑ ูู ุงูุฐู ูุธูุฑ -->
                            <input type="file" id="imageFileInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer h-full" onchange="handleFileSelect(event)">
                            <button type="button" class="w-full py-2 rounded-lg text-white bg-green-500 hover:bg-green-600 transition pointer-events-none">
                                ุงุฎุชูุงุฑ ุตูุฑุฉ ูู ุงูุฌูุงุฒ (ุงูุงุณุชุฏูู)
                            </button>
                        </div>

                        <!-- ุฅุธูุงุฑ ุงูุตูุฑุฉ ุงูููุชูุทุฉ/ุงููุฎุชุงุฑุฉ -->
                        <div id="capturedImagePreview" class="p-3 bg-secondary-gray rounded-lg border border-primary-blue/50 flex items-center justify-between">
                            <span class="text-gray-700 font-medium">ุตูุฑุฉ ุงูุฃููููุฉ ุงูุญุงููุฉ:</span>
                            <img id="previewIcon" src="https://placehold.co/48x48/D1D5DB/000?text=ุ" alt="ุตูุฑุฉ ุฃููููุฉ" class="product-image-icon">
                        </div>

                        <p id="imageStatus" class="error-message hidden">โ ูุฑุฌู ุงูุชูุงุท ุตูุฑุฉ ูุชุญุฏูุฏ ุฃููููุฉ ุงูุตูู.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ูุณู ุนุฑุถ ุจุทุงูุงุช ุงูุฃุตูุงู (Item Cards) -->
        <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">ุณุฌูุงุช ุงูุฃุตูุงู (<span id="productCount">0</span>)</h2>
        <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- ุณูุชู ุฅุถุงูุฉ ุจุทุงูุงุช ุงูุฃุตูุงู ููุง ุฏููุงููููุงู -->
            <div class="md:col-span-2 p-6 bg-secondary-gray rounded-xl text-center text-gray-500" id="emptyMessage">
                ูุง ุชูุฌุฏ ุฃุตูุงู ููุถุงูุฉ ุจุนุฏ.
            </div>
        </div>

    </div>

    <script>
        // ุงููุชุบูุฑุงุช ูุงูุซูุงุจุช ุงูุนุงูููุฉ
        const DB_NAME = 'ProductDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'products';
        let db; // ูุงุฆู ูุงุนุฏุฉ ุงูุจูุงูุงุช IndexedDB
        let productImageBase64 = null;
        let stream = null; 
        let isDbInitialized = false; // ูุคุดุฑ ูุญุงูุฉ ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
        
        // ุนูุงุตุฑ DOM
        const productNameInput = document.getElementById('productName');
        const productCodeInput = document.getElementById('productCode');
        const productPriceInput = document.getElementById('productPrice');
        const productsList = document.getElementById('productsList');
        const imageStatus = document.getElementById('imageStatus');
        const productCountSpan = document.getElementById('productCount');
        const cameraStream = document.getElementById('cameraStream');
        const photoCanvas = document.getElementById('photoCanvas');
        const captureButton = document.getElementById('captureButton');
        const startButton = document.getElementById('startButton');
        const capturePlaceholder = document.getElementById('capturePlaceholder');
        const cameraMessage = document.getElementById('cameraMessage');
        const previewIcon = document.getElementById('previewIcon');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const systemMessage = document.getElementById('systemMessage');
        const imageFileInput = document.getElementById('imageFileInput'); 

        /**
         * ุนุฑุถ ุฑุณุงูุฉ ูุธุงู ูุคูุชุฉ (ูุฌุงุญ ุฃู ูุดู)
         */
        function showSystemMessage(message, isError = false) {
            systemMessage.textContent = message;
            systemMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (isError) {
                systemMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                systemMessage.classList.add('bg-green-100', 'text-green-700');
            }

            // ุฅุฎูุงุก ุงูุฑุณุงูุฉ ุจุนุฏ 4 ุซูุงูู
            setTimeout(() => {
                systemMessage.classList.add('hidden');
            }, 4000);
        }

        // ------------------------------------------------------------------
        // ูุธุงุฆู IndexedDB
        // ------------------------------------------------------------------

        /**
         * ูุชุญ ุฃู ุฅูุดุงุก ูุงุนุฏุฉ ุจูุงูุงุช IndexedDB
         */
        function initDatabase() {
            loadingOverlay.classList.remove('hidden');
            console.log('โณ ุจุฏุก ุชููุฆุฉ IndexedDB...');

            return new Promise((resolve, reject) => {
                // ูุญุต ุฏุนู ุงููุชุตูุญ
                if (!window.indexedDB) {
                    const msg = "โ ูุชุตูุญู ูุง ูุฏุนู IndexedDB. ูู ูุชู ุญูุธ ุงูุจูุงูุงุช.";
                    showSystemMessage(msg, true);
                    loadingOverlay.classList.add('hidden');
                    return reject(new Error(msg));
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    const error = event.target.error;
                    const msg = `โ ูุดู ูู ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ: ${error ? error.name : 'Unknown Error'}`;
                    console.error("๐จ๐จ ุฎุทุฃ ุฃุซูุงุก ูุชุญ IndexedDB (request.onerror):", error);
                    showSystemMessage(msg, true);
                    loadingOverlay.classList.add('hidden');
                    reject(error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    isDbInitialized = true;
                    console.log("โ ุชู ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ.");
                    loadingOverlay.classList.add('hidden');
                    resolve(db);
                };

                // ูุชู ุชุดุบูู ูุฐุง ุงูุญุฏุซ ููุท ุนูุฏ ุฅูุดุงุก ุงููุงุนุฏุฉ ุฃู ุชุฑููุฉ ุงูุฅุตุฏุงุฑ
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    try {
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            objectStore.createIndex('name', 'name', { unique: false });
                            console.log("โ ุชู ุฅูุดุงุก ูุฎุฒู ุงููุงุฆูุงุช ุจูุฌุงุญ.");
                        }
                    } catch (e) {
                        console.error("๐จ๐จ ุฎุทุฃ ูู onupgradeneeded (ุฅูุดุงุก ุงููุฎุฒู):", e.name, e);
                        showSystemMessage(`โ ูุดูุช ุนูููุฉ ุฅุนุฏุงุฏ ุงูุชุฎุฒูู (ูุฏ ูููู ุงููุชุตูุญ ูู ูุถุน ุงูุชุตูุญ ุงูุฎุงุต). ${e.name}`, true);
                        reject(e);
                    }
                };
            });
        }

        /**
         * ุฌูุจ ุฌููุน ุงูุฃุตูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
         */
        function getProducts() {
            return new Promise((resolve, reject) => {
                if (!isDbInitialized || !db) {
                    resolve([]); 
                    return;
                }

                try {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.getAll();

                    request.onerror = (event) => {
                        console.error("โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช:", event.target.error);
                        reject(new Error("Failed to retrieve products"));
                    };

                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };
                } catch (e) {
                    console.error("โ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ูุนุงููุฉ ุงููุฑุงุกุฉ:", e);
                    reject(e);
                }
            });
        }

        /**
         * ุญูุธ ุตูู ุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
         */
        function saveProduct(product) {
            return new Promise((resolve, reject) => {
                if (!isDbInitialized || !db) {
                    return reject(new Error("Database object is null. Initialization failed or is pending."));
                }
                
                try {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    
                    transaction.oncomplete = () => {
                        console.log("โ ุงูุชููุช ูุนุงููุฉ ุงูุญูุธ ุจูุฌุงุญ.");
                    };
                    
                    transaction.onerror = (event) => {
                        // ูุฐุง ููุชูุท ูุนุธู ุฃุฎุทุงุก ุงููููุฏ ูุงูุชุฎุฒูู
                        const error = event.target.error;
                        console.error("๐จ๐จ ุฎุทุฃ ูู ูุนุงููุฉ ุงูุญูุธ (Transaction Error):", error.name, error);
                        reject(error);
                    };

                    const objectStore = transaction.objectStore(STORE_NAME);
                    const request = objectStore.add(product);

                    request.onsuccess = (event) => {
                        resolve(event.target.result); // ูุนูุฏ ุจูุนุฑู ุงูุตูู ุงูุฌุฏูุฏ
                    };

                    request.onerror = (event) => {
                        // ูุฐุง ููุชูุท ุฃุฎุทุงุก ุงูุฅุถุงูุฉ ุงููุจุงุดุฑุฉุ ููุฌุจ ุฃู ููุฑุฑูุง ุฅูู transaction.onerror
                         console.error("โ ุฎุทุฃ ูุจุงุดุฑ ูู ุทูุจ ุงูุฅุถุงูุฉ:", event.target.error);
                    };

                } catch (e) {
                    console.error("โ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ูุนุงููุฉ ุงููุชุงุจุฉ:", e);
                    reject(e);
                }
            });
        }

        /**
         * ุญุฐู ุตูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
         */
        function deleteProductFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!isDbInitialized || !db) {
                    return reject(new Error("Database not initialized"));
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);

                request.onerror = (event) => {
                    console.error("โ ุฎุทุฃ ูู ุญุฐู ุงูุตูู:", event.target.error);
                    reject(new Error("Failed to delete product"));
                };

                request.onsuccess = () => {
                    console.log(`โ ุชู ุญุฐู ุงูุตูู ุจูุฌุงุญ. ID: ${id}`);
                    resolve();
                };
            });
        }

        // ------------------------------------------------------------------
        // ูุธุงุฆู ุงููุงููุฑุง ูุงูููุทู ุงูุฑุฆูุณู
        // ------------------------------------------------------------------

        /**
         * ุชุดุบูู ุงููุงููุฑุง ูุนุฑุถ ุงููุฌุฑู ูู ุนูุตุฑ ุงูููุฏูู
         */
        async function startCamera() {
            if (stream) {
                // ุฅุฐุง ูุงูุช ุงููุงููุฑุง ุชุนููุ ุฃููููุง ุฃููุงู
                stopCamera();
                return;
            }

            try {
                cameraMessage.textContent = 'ุฌุงุฑู ุทูุจ ุงููุตูู ุฅูู ุงููุงููุฑุง...';
                
                let constraints = { video: { facingMode: 'environment' } };
                
                try {
                    // ุงููุญุงููุฉ ุงูุฃููู: ุงููุงููุฑุง ุงูุฎูููุฉ (environment)
                    stream = await navigator.mediaDevices.getUserMedia(constraints); 
                } catch (e) {
                    console.warn('โ๏ธ ูุดูุช ุงููุญุงููุฉ ุงูุฃููู (environment). ุชุฌุฑุจุฉ ุงููุงููุฑุง ุงูุฃูุงููุฉ/ุงูุนุงุฏูุฉ.');
                    
                    // ุงููุญุงููุฉ ุงูุซุงููุฉ: ุฃู ูุงููุฑุง ูุชุงุญุฉ (true) - ุฃูุซุฑ ูุฑููุฉ
                    constraints = { video: true };
                    stream = await navigator.mediaDevices.getUserMedia(constraints); 
                }
                
                cameraStream.srcObject = stream;
                cameraStream.classList.remove('hidden');
                capturePlaceholder.classList.add('hidden');
                startButton.textContent = 'ุฅููุงู ุงููุงููุฑุง';
                captureButton.disabled = false;
                cameraMessage.textContent = 'ุงููุงููุฑุง ุฌุงูุฒุฉ. ูู ุจุงูุชูุงุท ุงูุตูุฑุฉ.';

            } catch (error) {
                const errorName = error.name || 'UnknownError';
                console.error(`โ ูุดู ุงููุตูู ุฅูู ุงููุงููุฑุง: ${errorName}`, error);
                
                cameraMessage.textContent = `โ ูุดู ุงููุตูู (${errorName}): ูุฑุฌู ุงูุชุฃูุฏ ูู ููุญ ุงูุฅุฐู ูููุงููุฑุง.`;
                capturePlaceholder.classList.remove('hidden');
                cameraStream.classList.add('hidden');
                showSystemMessage(`โ ูุดู ุงููุตูู ุฅูู ุงููุงููุฑุง. ุงูุฎุทุฃ: ${errorName}`, true);
                captureButton.disabled = true;
            }
        }

        /**
         * ุงูุชูุงุท ุงูุตูุฑุฉ ูู ูุฌุฑู ุงูููุฏูู ูุชุญููููุง ุฅูู Base64
         */
        function capturePhoto() {
            if (!stream) {
                showSystemMessage('ูุฑุฌู ุชุดุบูู ุงููุงููุฑุง ุฃููุงู.', true);
                return;
            }

            const video = cameraStream;
            // ุถูุงู ุฃู ุงูููุฏูู ูุญุชูู ุนูู ุจูุงูุงุช ูุงุจูุฉ ููุงูุชูุงุท
            if (video.readyState < 2) { // 2 = HAVE_CURRENT_DATA
                 showSystemMessage('โ ุงูููุฏูู ุบูุฑ ุฌุงูุฒ ููุงูุชูุงุท ุจุนุฏุ ูุฑุฌู ุงูุงูุชุธุงุฑ ููููุงู.', true);
                 return;
            }

            // ุถุจุท ุญุฌู ุงููุงููุงุณ ูุญุฌู ุงูููุฏูู
            photoCanvas.width = video.videoWidth;
            photoCanvas.height = video.videoHeight;

            const context = photoCanvas.getContext('2d');
            context.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);

            // ุชุญููู ูุญุชูู ุงููุงููุงุณ ุฅูู Base64 PNG
            const dataUrl = photoCanvas.toDataURL('image/png', 0.8); // 0.8 ูุถุบุท ุจุณูุท
            productImageBase64 = dataUrl;
            
            // ุนุฑุถ ูุนุงููุฉ ุงูุตูุฑุฉ ุงูููุชูุทุฉ
            previewIcon.src = productImageBase64;
            imageStatus.classList.add('hidden');
            
            console.log(`โ ุชู ุงูุชูุงุท ุงูุตูุฑุฉ ูุชุญููููุง ุฅูู Base64 ุจูุฌุงุญ. ุงูุญุฌู: ${productImageBase64.length / 1024} KB`);
            
            // ุฅููุงู ุงููุงููุฑุง ุชููุงุฆูุงู ุจุนุฏ ุงูุงูุชูุงุท
            stopCamera();
            showSystemMessage('โ ุชู ุงูุชูุงุท ุงูุตูุฑุฉ ุจูุฌุงุญ. ููููู ุงูุขู ุญูุธ ุงูุตูู.');
        }

        /**
         * ุงูุชุนุงูู ูุน ุงุฎุชูุงุฑ ููู ุตูุฑุฉ ูู ุงูุฌูุงุฒ
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // ุฅููุงู ุงููุงููุฑุง ุฅุฐุง ูุงูุช ุชุนูู
            stopCamera();
            
            // ุงูุชุฃูุฏ ูู ุฃู ุงูููู ุตูุฑุฉ
            if (!file.type.startsWith('image/')) {
                showSystemMessage('โ ูุฌุจ ุฃู ูููู ุงูููู ุงููุฎุชุงุฑ ุตูุฑุฉ.', true);
                return;
            }

            const reader = new FileReader();

            reader.onload = (e) => {
                const dataUrl = e.target.result;
                productImageBase64 = dataUrl;
                
                // ุชุญุฏูุซ ุงููุนุงููุฉ
                previewIcon.src = productImageBase64;
                imageStatus.classList.add('hidden');
                
                showSystemMessage('โ ุชู ุงุฎุชูุงุฑ ุงูุตูุฑุฉ ูู ุงูุฌูุงุฒ ุจูุฌุงุญ. ููููู ุงูุขู ุญูุธ ุงูุตูู.');
            };

            reader.onerror = (error) => {
                console.error("โ ูุดู ูุฑุงุกุฉ ุงูููู:", error);
                showSystemMessage('โ ูุดู ูู ูุฑุงุกุฉ ููู ุงูุตูุฑุฉ ุงููุฎุชุงุฑุฉ.', true);
            };

            // ูุฑุงุกุฉ ุงูููู ูู Data URL (Base64)
            reader.readAsDataURL(file);
        }

        /**
         * ุฅููุงู ูุฌุฑู ุงููุงููุฑุง
         */
        function stopCamera() {
             if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                cameraStream.srcObject = null;
                startButton.textContent = 'ุชุดุบูู ุงููุงููุฑุง';
                captureButton.disabled = true;
                cameraMessage.textContent = 'ุงุถุบุท "ุชุดุบูู ุงููุงููุฑุง" ููุจุฏุก.';
                capturePlaceholder.classList.remove('hidden');
                cameraStream.classList.add('hidden');
            }
        }

        /**
         * ุชูููุฏ ููุฏ ุตูู ุนุดูุงุฆู
         */
        function generateCode() {
            return `P-${Math.random().toString(36).substring(2, 7).toUpperCase()}`;
        }


        /**
         * ุฅุถุงูุฉ ุงูุตูู ุฅูู IndexedDB
         */
        async function addProduct() {
            const name = productNameInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            let code = productCodeInput.value.trim() || generateCode();

            // ุงูุชุญูู ูู ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃููุงู
            if (!isDbInitialized || !db) {
                showSystemMessage('โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ุฌุงูุฒุฉ. ูุฑุฌู ุงูุงูุชุธุงุฑ ุญุชู ูุฎุชูู ุดุฑูุท ุงูุชุญููู ุฃู ุชุญุฏูุซ ุงูุตูุญุฉ.', true);
                console.error("๐จ๐จ ูุดู ุงูุญูุธ: IndexedDB ุบูุฑ ูููุฃุฉ ุฃู ุชููุฆุชูุง ูุดูุช ูุณุจูุงู.");
                return;
            }
            // ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
            if (name === "") {
                 showSystemMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุตูู.', true);
                 return;
            }
            if (isNaN(price) || price <= 0) {
                 showSystemMessage('โ ูุฑุฌู ุฅุฏุฎุงู ุณุนุฑ ุจูุน ุตุญูุญ ูููุฌุจ.', true);
                 return;
            }
            if (!productImageBase64) {
                imageStatus.classList.remove('hidden');
                showSystemMessage('โ ูุฑุฌู ุงูุชูุงุท ุตูุฑุฉ ุฃู ุงุฎุชูุงุฑูุง ูุชุญุฏูุฏ ุฃููููุฉ ุงูุตูู.', true);
                return;
            }

            const newProduct = {
                code: code,
                name: name,
                price: price.toFixed(2),
                image: productImageBase64 
            };

            try {
                // ุญูุธ ูู IndexedDB
                const newId = await saveProduct(newProduct);
                console.log(`โ ุชู ุงูุญูุธ ุจูุฌุงุญ. ูุนุฑู ุฌุฏูุฏ: ${newId}`);

                // ุชุตููุฑ ุงูุญููู ููุชุบูุฑุงุช ุงูุตูุฑุฉ
                productCodeInput.value = '';
                productNameInput.value = '';
                productPriceInput.value = '';
                productImageBase64 = null; 
                previewIcon.src = "https://placehold.co/48x48/D1D5DB/000?text=ุ";
                imageFileInput.value = ''; // ุชุตููุฑ ุญูู ุงูููู
                imageStatus.classList.add('hidden');

                // ุฅุนุงุฏุฉ ุนุฑุถ ุงููุงุฆูุฉ
                await renderProducts();
                
                showSystemMessage(`โ ุชู ุญูุธ ุงูุตูู "${name}" ุจูุฌุงุญ.`);

            } catch (error) {
                // ุนุฑุถ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูุนุงูุฉ ูุชุณุฌูู ุงูุชูุงุตูู ูู Console
                const errorName = error ? error.name : 'UnknownError';
                const errorMessage = `โ ูุดู ุญูุธ ุงูุตูู "${name}". ุฎุทุฃ: ${errorName}. ูุฑุฌู ูุชุญ Console (F12) ูุฑุคูุฉ ุงูุชูุงุตูู ุงููุงููุฉ.`;
                showSystemMessage(errorMessage, true);
                // ุชูุงุตูู ุงูุฎุทุฃ ุงููุงููุฉ ูุณุฌูุฉ ุจุงููุนู ูู saveProduct
            }
        }

        /**
         * ุนุฑุถ ุงูุฃุตูุงู ูู ุงููุงุฌูุฉ ุงูุฑุณูููุฉ ุจุนุฏ ุฌูุจูุง ูู IndexedDB
         */
        async function renderProducts() {
            let products;
            try {
                products = await getProducts();
            } catch (error) {
                console.error("ูุดู ุฌูุจ ุงูุฃุตูุงู:", error);
                productsList.innerHTML = `<div class="md:col-span-2 p-6 bg-red-100 rounded-xl text-center text-red-700">ูุดู ูู ุชุญููู ุงูุฃุตูุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.</div>`;
                return;
            }

            productsList.innerHTML = ''; // ูุณุญ ุงููุงุฆูุฉ ุงูุญุงููุฉ

            if (products.length === 0) {
                document.getElementById('emptyMessage').classList.remove('hidden');
                productCountSpan.textContent = 0;
                return;
            }

            document.getElementById('emptyMessage').classList.add('hidden');
            productCountSpan.textContent = products.length;

            products.forEach(product => {
                const productCard = document.createElement('div');
                // ุฅุถุงูุฉ ูุนุฑู ุงูุจูุงูุงุช ูููุณุงุนุฏุฉ ูู ุงูุญุฐู ูุชุฌูุจ ุงุณุชุฎุฏุงู confirm() ุงููุญุธูุฑ
                productCard.setAttribute('data-product-id', product.id); 
                
                // ุชุตููู ุจุทุงูุฉ ุงูุตูู (Item Card)
                productCard.className = 'bg-white border-2 border-primary-blue/30 rounded-xl shadow-lg p-5 transition hover:shadow-xl relative overflow-hidden';
                
                // ุงุณุชุฎุฏุงู `product.id` ุงูุฐู ุชููุฏู IndexedDB ูุนูููุฉ ุงูุญุฐู
                productCard.innerHTML = `
                    <!-- ุฃููููุฉ ุงูุตูุฑุฉ ุงููุตุบุฑุฉ ูู ุงูุฒุงููุฉ ุงูุนูููุฉ -->
                    <div class="absolute top-0 left-0 m-4">
                        <img src="${product.image}" alt="ุตูุฑุฉ ${product.name}" class="product-image-icon border-primary-blue/50" onerror="this.src='https://placehold.co/48x48/DCFCE7/10B981?text=A';">
                    </div>
                    
                    <div class="space-y-3 pt-4">
                        <!-- ููุฏ ุงูุตูู -->
                        <div class="flex items-center">
                            <span class="text-xs font-semibold uppercase px-2 py-0.5 rounded-full bg-primary-blue/20 text-primary-blue ml-2">${product.code}</span>
                            <span class="text-sm text-gray-500">ููุฏ ุงูุตูู</span>
                        </div>
                        
                        <!-- ุงุณู ุงูุตูู (ุนููุงู ุงูุจุทุงูุฉ) -->
                        <h3 class="text-2xl font-extrabold text-gray-900 pr-16">${product.name}</h3>
                        
                        <!-- ุชูุงุตูู ุฅุถุงููุฉ (ุงูุฃุณุนุงุฑ ูุงูุฃุฑุตุฏุฉ) -->
                        <div class="flex justify-between items-end border-t border-gray-100 pt-3 mt-4">
                            <div>
                                <p class="text-xs text-gray-500">ุณุนุฑ ุงูุจูุน</p>
                                <p class="text-2xl font-bold text-red-600">${product.price} ุฑ.ุณ</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">ุงูุฑุตูุฏ ุงูุญุงูู</p>
                                <p class="text-2xl font-bold text-gray-700">${(Math.random() * 100).toFixed(0)}</p>
                            </div>
                        </div>
                        
                        <!-- ุฒุฑ ุญุฐู ุงูุจุทุงูุฉ -->
                        <div class="text-left mt-4">
                            <button onclick="handleDelete(${product.id})" class="text-sm text-red-500 hover:text-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                ุญุฐู
                            </button>
                        </div>
                    </div>
                `;
                productsList.appendChild(productCard);
            });
        }
        
        /**
         * ุงูุชุนุงูู ูุน ุทูุจ ุงูุญุฐู (ุชูุช ุฅุฒุงูุฉ confirm() ุชูุงุดูุงู ูุน ููุงุนุฏ ุงูุจูุฆุฉ)
         */
        async function handleDelete(id) {
            // ุญุฐู ุงูุนูุตุฑ ูู ุงููุงุฌูุฉ ุงูุฑุณูููุฉ ุฃููุงู (Optimistic removal)
            const productElement = document.querySelector(`[data-product-id="${id}"]`);
            if (productElement) productElement.remove(); 
            
            try {
                await deleteProductFromDB(id);
                // ุฅุนุงุฏุฉ ุนุฑุถ ุงููุงุฆูุฉ ูุชุญุฏูุซ ุงูุนุฏุฏ
                await renderProducts();
                showSystemMessage('โ ุชู ุญุฐู ุงูุตูู ุจูุฌุงุญ.');
            } catch (error) {
                showSystemMessage('โ ูุดู ุญุฐู ุงูุตูู. ุชุญูู ูู ุณุฌู ุงููุชุตูุญ.', true);
                console.error("ูุดู ุญุฐู ุงูุตูู:", error);
                // ุฅุฐุง ูุดู ุงูุญุฐูุ ุฃุนุฏ ุฅุถุงูุฉ ุงูุจุทุงูุฉ (ููุชุทุจูู ุงููุงููุ ูุฐุง ูุชุทูุจ ุฅุนุงุฏุฉ ุชุญููู ุงูููุชุฌ ุงููุญุฐูู)
                await renderProducts();
            }
        }

        // ุฅููุงู ุงููุงููุฑุง ุนูุฏ ุฅุบูุงู ุงูุตูุญุฉ ูุถูุงู ุชุญุฑูุฑ ุงูููุงุฑุฏ
        window.addEventListener('beforeunload', stopCamera);
        
        // ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        window.onload = async () => {
            try {
                await initDatabase();
                await renderProducts();
            } catch (error) {
                // ุฅุฐุง ูุดูุช ุงูุชููุฆุฉุ ูุชู ุงูุชุนุงูู ูุนูุง ูู initDatabase
            }
        };

    </script>
</body>
</html>

